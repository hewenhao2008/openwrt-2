# This file is interpreted as shell script.
# Put your custom iptables rules here, they will
# be executed with each firewall (re-)start.
iptables -N connlim
iptables -N marking -t mangle
iptables -A connlim -p tcp -m limit --limit 10/s --limit-burst 10 -j RETURN
iptables -A connlim -p udp -m limit --limit 5/s --limit-burst 5 -j RETURN
iptables -A connlim -p tcp -j DROP
iptables -A connlim -p udp -j DROP
iptables -I forward -p tcp -m tcp --sport 1024:65535 --dport 1024:65535 -j connlim 
iptables -I forward -p udp -m udp --sport 1024:65535 --dport 1024:65535 -j connlim
iptables -I zone_lan_forward -p udp -m connlimit --connlimit-above 20 -j DROP
iptables -I zone_lan_forward -p tcp -m connlimit --connlimit-above 80 -j DROP
iptables -I zone_oth_forward -p udp -m connlimit --connlimit-above 20 -j DROP
iptables -I zone_oth_forward -p tcp -m connlimit --connlimit-above 80 -j DROP
iptables -I zone_floor5_forward -p udp -m connlimit --connlimit-above 10 -j DROP
iptables -I zone_floor5_forward -p tcp -m connlimit --connlimit-above 40 -j DROP


iptables -A PREROUTING -t mangle -i wan -j CONNMARK --restore-mark
iptables -A PREROUTING -t mangle -i wan -j IMQ --todev 0

iptables -A marking -t mangle -i wan -o br-oth -j MARK --set-mark 1
iptables -A marking -t mangle -i br-oth -o wan -j MARK --set-mark 1
iptables -A marking -t mangle -i wan -o br-lan -j MARK --set-mark 2
iptables -A marking -t mangle -i br-lan -o wan -j MARK --set-mark 2
iptables -A marking -t mangle -i wan -o br-lan.20 -j MARK --set-mark 3
iptables -A marking -t mangle -i br-lan.20 -o wan -j MARK --set-mark 3
iptables -A marking -t mangle -p udp -m udp --sport 1024:65535 --dport 1024:65535 -j MARK --set-mark 4
iptables -A marking -t mangle -p tcp -m tcp --sport 1024:65535 --dport 1024:65535 -j MARK --set-mark 4
iptables -A marking -t mangle -j CONNMARK --save-mark 

iptables -A FORWARD -t mangle -m mark --mark 0 -j marking

ifconfig imq0 up
tc qdisc del dev imq0 root
tc qdisc del dev wan root
tc qdisc add dev wan root handle 1: htb default 40
tc qdisc add dev imq0 root handle 1: htb default 40
tc class add dev wan parent 1:  classid 1:1  htb rate 9000kbit  ceil 9000kbit
tc class add dev imq0 parent 1:  classid 1:1  htb rate 9000kbit  ceil 9000kbit
tc class add dev wan parent 1:1  classid 1:10  htb rate 3000kbit  ceil 9000kbit burst 10000b
tc class add dev wan parent 1:1  classid 1:20  htb rate 4000kbit  ceil 9000kbit burst 10000b
tc class add dev wan parent 1:1  classid 1:30  htb rate 1000kbit  ceil 3000kbit burst 10000b
tc class add dev wan parent 1:1  classid 1:40  htb rate 1000kbit  ceil 3000kbit burst 10000b
tc class add dev imq0 parent 1:1  classid 1:10  htb rate 3000kbit  ceil 9000kbit burst 10000b
tc class add dev imq0 parent 1:1  classid 1:20  htb rate 4000kbit  ceil 9000kbit burst 10000b
tc class add dev imq0 parent 1:1  classid 1:30  htb rate 1000kbit  ceil 3000kbit burst 10000b
tc class add dev imq0 parent 1:1  classid 1:40  htb rate 1000kbit  ceil 3000kbit burst 10000b 
tc qdisc add dev imq0 parent 1:10 handle 10: esfq hash ctorigdst
tc qdisc add dev imq0 parent 1:20 handle 20: esfq hash ctorigdst
tc qdisc add dev imq0 parent 1:30 handle 30: esfq hash ctorigdst
tc qdisc add dev imq0 parent 1:40 handle 40: esfq hash ctorigdst
tc qdisc add dev wan parent 1:10 handle 10: esfq hash ctorigsrc
tc qdisc add dev wan parent 1:20 handle 20: esfq hash ctorigsrc
tc qdisc add dev wan parent 1:30 handle 30: esfq hash ctorigsrc
tc qdisc add dev wan parent 1:40 handle 40: esfq hash ctorigsrc
tc filter add dev imq0 protocol ip parent 1:0 handle 1 fw flowid 1:10
tc filter add dev imq0 protocol ip parent 1:0 handle 2 fw flowid 1:20
tc filter add dev imq0 protocol ip parent 1:0 handle 3 fw flowid 1:30
tc filter add dev imq0 protocol ip parent 1:0 handle 4 fw flowid 1:40
tc filter add dev wan protocol ip parent 1:0 handle 1 fw flowid 1:10
tc filter add dev wan protocol ip parent 1:0 handle 2 fw flowid 1:20
tc filter add dev wan protocol ip parent 1:0 handle 3 fw flowid 1:30
tc filter add dev wan protocol ip parent 1:0 handle 4 fw flowid 1:40
